<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /><stop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /></linearGradient></defs><circle cx='50' cy='50' r='45' fill='url(%23grad)'/><text x='50' y='40' font-family='Arial, sans-serif' font-size='24' font-weight='900' fill='white' text-anchor='middle'>MaaS</text><text x='50' y='65' font-family='Arial, sans-serif' font-size='8' font-weight='600' fill='white' text-anchor='middle'>Ù‚ÙŠØ§Ø³Ø§Øª Ø°ÙƒÙŠØ©</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /><stop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23grad)'/><text x='50' y='65' font-family='Arial, sans-serif' font-size='40' font-weight='900' fill='white' text-anchor='middle'>MaaS</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1d4ed8;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --info: #0891b2;
            --dark: #1f2937;
            --light: #f9fafb;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --bg: #f0f4f8;
            --card: #ffffff;
            --text-main: #1e293b;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            margin: 0;
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .exam-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-bottom: 4px solid var(--primary);
        }

        .timer-container {
            background: #fff1f2;
            color: var(--danger);
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.5rem;
            border: 2px solid #fecdd3;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ */
        .screen { display: none; padding: 50px 20px; max-width: 1000px; margin: 0 auto; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .question-card {
            background: var(--card);
            border-radius: 30px;
            padding: 45px;
            margin-bottom: 60px; /* Ù…Ø¨Ø§Ø¹Ø¯Ø© Ø¶Ø®Ù…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ */
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .passage-content {
            background: #fffbeb;
            border-right: 10px solid var(--warning);
            padding: 35px;
            border-radius: 20px;
            line-height: 2;
            font-size: 1.25rem;
            margin-bottom: 40px;
            color: #451a03;
        }

        .question-header {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 25px;
            color: #0f172a;
            display: flex;
            gap: 15px;
        }

        .option-box {
            background: #f8fafc;
            border: 2px solid #f1f5f9;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
        }

        .option-box:hover { border-color: var(--primary); background: #f0f7ff; }
        .option-box.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }

        textarea {
            width: 100%;
            padding: 25px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            font-family: 'Cairo';
            font-size: 1.1rem;
            min-height: 200px;
            resize: vertical;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-main {
            background: var(--primary);
            color: white;
            padding: 20px 50px;
            border: none;
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
        }

        .btn-main:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(67,97,238,0.2); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± */
        .status-card { text-align: center; padding: 60px; }
        .score-display {
            font-size: 5rem;
            font-weight: 900;
            color: var(--success);
            margin: 20px 0;
            text-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary);
            border-radius: 50%;
            width: 80px; height: 80px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="exam-nav" style="display: none;">
        <div>
            <strong id="st-name-display" style="font-size: 1.2rem; color: var(--primary);">--</strong><br>
            <small id="ex-title-display" style="color: #64748b; font-weight: 700;">--</small>
        </div>
        <div class="timer-container">
            <span id="timer-icon">â³</span>
            <span id="timer-clock">00:00</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="exam_codes.html" class="btn" style="background: var(--info); padding: 8px 16px; font-size: 0.9rem;">
                ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ÙƒÙˆØ§Ø¯
            </a>
            <a href="home.html" class="btn" style="background: var(--secondary); padding: 8px 16px; font-size: 0.9rem;">
                ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <div class="question-card status-card">
            <h1 style="font-weight: 900; font-size: 2.5rem; color: var(--primary);">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ© ğŸ‘‹</h1>
            <p style="color: #64748b; font-size: 1.1rem; margin-bottom: 40px;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ</p>
            
            <div style="max-width: 400px; margin: 0 auto;">
                <input type="text" id="student-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." 
                       style="text-align: center; font-size: 1.2rem; margin-bottom: 25px; border-width: 3px;">
                <button class="btn-main" onclick="startExam()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ”“</button>
            </div>
            
            <p style="margin-top: 30px; font-size: 0.9rem; color: var(--danger);">* Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ØŒ Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§Ø²Ù„.</p>
        </div>
    </div>

    <div id="screen-exam" class="screen">
        <div id="dynamic-questions-container">
            </div>
        
        <div style="margin-top: 80px; padding-bottom: 100px;">
            <button class="btn-main" style="background: var(--success);" onclick="submitExam()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… ğŸš€</button>
        </div>
    </div>

    <div id="screen-waiting" class="screen">
        <div class="question-card status-card">
            <div style="font-size: 5rem;">ğŸ“</div>
            <h1 style="color: var(--primary); font-weight: 900;">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ!</h1>
            <p style="font-size: 1.2rem; color: #475569;">Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø¢Ù† ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØµØ­ÙŠØ­.</p>
            
            <div class="loader"></div>
            
            <p style="font-weight: 700; color: var(--warning);">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©.. Ø³ØªØ¸Ù‡Ø± Ø¯Ø±Ø¬ØªÙƒ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙˆØ± Ø±ØµØ¯Ù‡Ø§.</p>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="question-card status-card">
            <div style="font-size: 5rem;">ğŸ“</div>
            <h1 style="margin-bottom: 10px;">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h1>
            <p style="color: #64748b;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="res-student-name" style="color: var(--text-main); font-weight: 800;"></span></p>
            
            <div class="score-display" id="final-score-box">0</div>
            
            <h2 style="color: #64748b; margin-top: 0;">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h2>
            
            <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
                <button class="btn-main" style="width: auto; padding: 15px 40px;" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ“„</button>
                <button class="btn-main" style="width: auto; padding: 15px 40px; background: #64748b;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

<script>
    const _supabase = supabase.createClient('https://hnldjfcvztnrhkwjmetf.supabase.co', 'sb_publishable_ldtY51QgRs0yg8sxnqhIkA_0qKvVXMU');
    const examId = new URLSearchParams(window.location.search).get('eid');
    
    let studentName = "";
    let studentEmail = "";
    let answers = {};
    let timeLeft = 0;
    let originalTime = 0;
    let timerInterval;

    // 1. Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function startExam() {
        studentName = document.getElementById('student-name-input').value;
        if (!studentName || studentName.length < 3) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹!");
        if (!examId) return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± ØµØ§Ù„Ø­.");

        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let exam;
            try {
                const { data: examData, error } = await _supabase.from('exams').select('*').eq('id', examId).single();
                if (!error && examData) {
                    exam = examData;
                }
            } catch (dbError) {
                console.log('Database error, using sample data');
            }

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            if (!exam) {
                exam = getSampleExamData(examId);
                if (!exam) {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.");
                }
            }

            // Ø¶Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('st-name-display').innerText = studentName;
            document.getElementById('ex-title-display').innerText = exam.title;
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-exam').classList.add('active');
            document.querySelector('.exam-nav').style.display = 'flex';

            // Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª
            timeLeft = (exam.exam_layout?.duration || 30) * 60;
            originalTime = timeLeft;
            runTimer();

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            renderExamBlocks(exam.exam_layout?.blocks || exam.blocks || []);

        } catch (err) {
            alert(err.message);
        }
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    function getSampleExamData(examId) {
        const sampleExams = {
            'test1': {
                id: 'test1',
                title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ',
                exam_layout: {
                    duration: 30,
                    blocks: [
                        {
                            id: 'q1',
                            type: 'mcq',
                            content: 'Ù…Ø§ Ù‡ÙŠ Ù†ØªÙŠØ¬Ø© 5 + 3ØŸ',
                            options: ['7', '8', '9', '10'],
                            correct: '8',
                            points: 1
                        },
                        {
                            id: 'q2',
                            type: 'mcq',
                            content: 'Ù…Ø§ Ù‡Ùˆ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ù‚Ù… 4ØŸ',
                            options: ['12', '14', '16', '18'],
                            correct: '16',
                            points: 1
                        },
                        {
                            id: 'q3',
                            type: 'truefalse',
                            content: 'Ø§Ù„Ø¹Ø¯Ø¯ 7 Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠ',
                            correct: 'ØµØ­',
                            points: 1
                        }
                    ]
                }
            },
            'test2': {
                id: 'test2',
                title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                exam_layout: {
                    duration: 45,
                    blocks: [
                        {
                            id: 'q1',
                            type: 'mcq',
                            content: 'Ù…Ø§ Ù‡Ùˆ Ø¬Ù…Ø¹ ÙƒÙ„Ù…Ø© "ÙƒØªØ§Ø¨"ØŸ',
                            options: ['ÙƒØªØ¨', 'ÙƒØªØ§Ø¨Ø§Øª', 'ÙƒØªØ§Ø¦Ø¨', 'ÙƒØ§ØªØ¨Ø§Øª'],
                            correct: 'ÙƒØªØ¨',
                            points: 1
                        },
                        {
                            id: 'q2',
                            type: 'mcq',
                            content: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ù„ÙƒÙ„Ù…Ø© "Ù„ÙŠÙ„"ØŸ',
                            options: ['Ù†Ù‡Ø§Ø±', 'ØµØ¨Ø§Ø­', 'Ù…Ø³Ø§Ø¡', 'ÙØ¬Ø±'],
                            correct: 'Ù†Ù‡Ø§Ø±',
                            points: 1
                        }
                    ]
                }
            },
            'test3': {
                id: 'test3',
                title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¹Ø§Ù…Ø©',
                exam_layout: {
                    duration: 60,
                    blocks: [
                        {
                            id: 'q1',
                            type: 'mcq',
                            content: 'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ',
                            options: ['7', '8', '9', '10'],
                            correct: '8',
                            points: 1
                        },
                        {
                            id: 'q2',
                            type: 'truefalse',
                            content: 'Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø­ÙŠØ§Ø©',
                            correct: 'ØµØ­',
                            points: 1
                        }
                    ]
                }
            }
        };

        return sampleExams[examId] || null;
    }

    // 2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    function renderExamBlocks(blocks) {
        const container = document.getElementById('dynamic-questions-container');
        blocks.forEach((block, index) => {
            const blockDiv = document.createElement('div');
            
            if (block.type === 'passage') {
                blockDiv.className = 'passage-content';
                blockDiv.innerHTML = `<strong>ğŸ“– Ù†Øµ Ø§Ù„Ù‚Ø·Ø¹Ø©:</strong><br><p>${block.content}</p>`;
            } else {
                blockDiv.className = 'question-card';
                let html = `
                    <div class="question-header">
                        <span style="color: var(--primary);">Ø³${index + 1}:</span>
                        <span>${block.content}</span>
                    </div>
                `;

                if (block.type === 'mcq') {
                    html += `<div style="display: grid; gap: 15px;">`;
                    block.options.filter(opt => opt.trim() !== "").forEach(opt => {
                        html += `
                            <div class="option-box" onclick="selectOption(this, '${block.id}', '${opt}')">
                                <div class="radio-circle"></div>
                                <span>${opt}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else {
                    html += `<textarea placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù‡Ù†Ø§..." oninput="saveEssayAnswer('${block.id}', this.value)"></textarea>`;
                }
                blockDiv.innerHTML = html;
            }
            container.appendChild(blockDiv);
        });
    }

    // 3. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    function selectOption(el, qId, val) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„
        const parent = el.parentElement;
        parent.querySelectorAll('.option-box').forEach(box => box.classList.remove('selected'));
        el.classList.add('selected');
        answers[qId] = val;
    }

    function saveEssayAnswer(qId, val) {
        answers[qId] = val;
    }

    // 4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØª
    function runTimer() {
        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø³ÙŠØªÙ… ØªØ³Ù„ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
                submitExam(true);
            }
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer-clock').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timeLeft--;
        }, 1000);
    }

    // 5. ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    async function submitExam(auto = false) {
        if (!auto && !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ.")) return;

        clearInterval(timerInterval);
        document.getElementById('screen-exam').classList.remove('active');
        document.querySelector('.exam-nav').style.display = 'none';
        document.getElementById('screen-waiting').classList.add('active');

        try {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ø¯Ø±Ø¬Ø©
            let correctAnswers = 0;
            let totalPoints = 0;
            let earnedPoints = 0;
            
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©
            const { data: examData } = await _supabase
                .from('exams')
                .select('exam_layout')
                .eq('id', examId)
                .single();
            
            if (examData && examData.exam_layout) {
                const blocks = examData.exam_layout.blocks || [];
                const questions = blocks.filter(b => b.type !== 'passage');
                
                questions.forEach(question => {
                    const studentAnswer = answers[question.id];
                    const correctAnswer = question.correct;
                    const questionPoints = question.points || 1;
                    
                    totalPoints += questionPoints;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                    if (studentAnswer && studentAnswer === correctAnswer) {
                        correctAnswers++;
                        earnedPoints += questionPoints;
                    }
                });
            }
            
            const percentage = totalPoints > 0 ? (earnedPoints / totalPoints * 100).toFixed(2) : 0;

            const { data, error } = await _supabase.from('student_results').insert([{
                exam_id: examId,
                student_name: studentName,
                student_email: null,
                answers: answers,
                score: earnedPoints,
                total_questions: questions.length,
                correct_answers: correctAnswers,
                percentage: parseFloat(percentage),
                time_taken: Math.floor((originalTime - timeLeft) / 60), // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                submitted_at: new Date().toISOString()
            }]).select();

            if (error) throw error;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø·Ø§Ù„Ø¨
            showFinalResult({
                student_name: studentName,
                score: earnedPoints,
                total_questions: questions.length,
                correct_answers: correctAnswers,
                percentage: percentage
            });

        } catch (err) {
            console.error("Submit Error:", err);
            alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + err.message);
        }
    }

    // 6. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…
    function startMonitoringResult(submissionId) {
        const monitorInterval = setInterval(async () => {
            const { data, error } = await _supabase
                .from('students')
                .select('final_score, status, student_name')
                .eq('id', submissionId)
                .single();

            if (data && data.status === 'approved') {
                clearInterval(monitorInterval);
                showFinalResult(data);
            }
        }, 4000); // ÙŠÙØ­Øµ ÙƒÙ„ 4 Ø«ÙˆØ§Ù†Ù
    }

    function showFinalResult(data) {
        document.getElementById('screen-waiting').classList.remove('active');
        document.getElementById('screen-result').classList.add('active');
        document.getElementById('res-student-name').innerText = data.student_name;
        document.getElementById('final-score-box').innerText = data.score;
        
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        const resultInfo = document.querySelector('.score-display').nextElementSibling;
        if (resultInfo) {
            resultInfo.innerHTML = `
                <p style="color: #64748b; margin-top: 10px;">
                    Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${data.correct_answers} Ù…Ù† ${data.total_questions} (${data.percentage}%)
                </p>
            `;
        }
    }
</script>
</body>
</html>